# bakctl 备份管理工具实现进度

## 项目概述
bakctl 是一个用 Go 语言开发的备份管理 CLI 工具，支持任务配置、备份执行、日志查看和任务编辑等功能。

## 目录结构
```
bakctl/
├── cmd/
│   ├── bakctl/           # 主程序入口
│   │   └── main.go       # ✅ 已实现 - 主命令行程序
│   └── subcmd/           # 子命令模块
│       ├── add/          # ✅ 已实现 - 添加备份任务
│       │   ├── add.go    # 任务添加逻辑
│       │   └── flags.go  # 命令行标志定义
│       ├── edit/         # ✅ 已实现 - 编辑备份任务
│       │   ├── edit.go   # 任务编辑逻辑
│       │   └── flags.go  # 编辑命令标志定义
│       ├── list/         # ✅ 已实现 - 列出备份任务
│       │   └── list.go   # 任务列表显示
│       └── log/          # ✅ 已实现 - 查看备份日志
│           └── log.go    # 日志查看功能
└── internal/
    ├── db/               # ✅ 已实现 - 数据库操作
    │   └── db.go         # 数据库连接和操作函数
    ├── types/            # ✅ 已实现 - 数据类型定义
    │   └── types.go      # 备份任务和日志结构体
    └── utils/            # ✅ 已实现 - 工具函数
        └── utils.go      # JSON 序列化等工具函数
```

## 已实现功能

### 1. 核心数据库操作 ✅
- **文件**: `internal/db/db.go`
- **功能**:
  - 数据库连接和初始化
  - 备份任务 CRUD 操作
  - 备份日志记录和查询
  - 目录创建辅助函数 `ensureDir`
  - 存储目录路径优化（存储目录 + 备份源目录名）
  - 移除冗余的 `Ping()` 调用（sqlx.Connect 自动处理）

### 2. 数据类型定义 ✅
- **文件**: `internal/types/types.go`
- **功能**:
  - `BackupTask` 结构体：备份任务配置
  - `BackupLog` 结构体：备份执行日志
  - 完整的字段定义和数据库标签

### 3. 工具函数 ✅
- **文件**: `internal/utils/utils.go`
- **功能**:
  - JSON 规则序列化/反序列化
  - 字符串处理工具函数

### 4. 添加任务命令 ✅
- **文件**: `cmd/subcmd/add/`
- **功能**:
  - 支持配置文件和命令行标志两种方式
  - 完整的标志定义（保留策略、压缩、规则、文件大小限制等）
  - 压缩标志使用 `-C` 缩写
  - 参数验证和错误处理

### 5. 编辑任务命令 ✅
- **文件**: `cmd/subcmd/edit/`
- **功能**:
  - 支持单个任务 (`--id`) 和批量任务 (`--ids`) 编辑
  - 使用 qflag.SliceFlag 处理多个 ID
  - 优化的标志比较逻辑：
    - 数值标志使用 `-1` 作为未设置标识
    - 压缩标志使用字符串类型支持三态逻辑
    - 添加 `--clear-include` 和 `--clear-exclude` 清空规则
  - 先查询当前配置，再执行固定 SQL 更新
  - 只在值确实改变时才更新

### 6. 列表显示命令 ✅
- **文件**: `cmd/subcmd/list/list.go`
- **功能**:
  - 任务列表展示
  - 格式化输出

### 7. 日志查看命令 ✅
- **文件**: `cmd/subcmd/log/log.go`
- **功能**:
  - 备份日志查看
  - 空备份文件名显示为 "-" 保持一致性

### 8. 主程序入口 ✅
- **文件**: `cmd/bakctl/main.go`
- **功能**:
  - 集成所有子命令
  - 命令行参数解析
  - 数据库连接管理

## 技术特点

### 已优化的设计模式
1. **代码复用**: 提取 `ensureDir` 辅助函数消除重复代码
2. **三态逻辑**: 编辑命令支持"未设置"/"true"/"false"三种状态
3. **批量操作**: 支持同时编辑多个任务
4. **固定 SQL**: 使用预定义 SQL 语句提高性能
5. **路径优化**: 存储目录自动包含备份源目录名

### 使用的技术栈
- **数据库**: SQLite + sqlx
- **命令行**: qflag 库
- **JSON**: 标准库处理规则序列化
- **路径处理**: filepath 包

## 待实现功能 🚧

### 1. 备份执行引擎 ❌
- **优先级**: 高
- **功能**:
  - 实际的文件备份逻辑
  - 压缩功能实现
  - 文件过滤（包含/排除规则）
  - 增量备份支持
  - 进度显示

### 2. 定时任务调度 ❌
- **优先级**: 中
- **功能**:
  - cron 表达式支持
  - 后台任务执行
  - 任务状态监控

### 3. 备份清理机制 ❌
- **优先级**: 中
- **功能**:
  - 按保留数量清理
  - 按保留天数清理
  - 存储空间管理

### 4. 配置管理 ❌
- **优先级**: 低
- **功能**:
  - 全局配置文件
  - 配置验证
  - 配置导入/导出

### 5. 监控和通知 ❌
- **优先级**: 低
- **功能**:
  - 备份状态通知
  - 错误报警
  - 统计报告

## 下一步开发建议

1. **立即任务**: 实现备份执行引擎，这是核心功能
2. **测试**: 为现有功能编写单元测试
3. **文档**: 完善 README 和使用说明
4. **打包**: 添加构建脚本和发布流程

## 已知问题和改进点

1. **错误处理**: 可以进一步优化错误信息的用户友好性
2. **性能**: 大量任务时的列表显示可能需要分页
3. **安全**: 添加配置文件权限检查
4. **国际化**: 考虑支持多语言

---
*最后更新: 2025/8/29 18:05*
*当前状态: 基础框架完成，核心备份功能待实现*